<!doctype html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>EmailNameGen</title>
	<style>
	html, body {
		width: 100%;
		height: 100%;
	}
	</style>
	<script src="./crypto.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jssha@3.1.2/dist/sha.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/eruda@2.4.1/eruda.min.js"></script>
</head>
<body>
	<label for="">
		key:
		<textarea name="" id="inpKey" cols="30" rows="10"></textarea>
	</label>
	<br />
	<label for="">
		name:
		<textarea name="" id="inpName" cols="30" rows="10"></textarea>
		<button id="btnClearName">Clear</button>
	</label>
	<br />
	<label for="">
		output:
		<textarea name="" id="out" cols="30" rows="10"></textarea>
		<button id="btnCopyToClipboard">Copy to clipboard</button>
	</label>
	
	<script>
eruda.init()

let elKey = document.getElementById('inpKey'),
	elName = document.getElementById('inpName'),
	elOut = document.getElementById('out')

function calcKeyHash(key) {
	let shaObj = new jsSHA('SHA3-512', 'TEXT', { encoding: 'UTF8' })
	shaObj.update(key)
	return shaObj.getHash('HEX').substring(0, 32)
}

function calcOutput(key, name) {
	let kh = calcKeyHash(key),
		cipher = cryptoBrowserify.createCipheriv('aes-256-gcm', kh, kh),
		ctext = cipher.update(name, 'utf8', 'base64')
	try {
		ctext += cipher.final('base64')
	} catch {}
	return ctext.replace(/\//g, '-').replace('==', '--').replace('=', '---').replace(/\+/g, '----')
}

function calcName(key, out) {
	let kh = calcKeyHash(key),
		decipher = cryptoBrowserify.createDecipheriv('aes-256-gcm', kh, kh),
		text = decipher.update(out.replace('----', '+').replace('---', '=').replace('--', '==').replace(/-/g, '\\'), 'base64', 'utf8')
	try {
		text += decipher.final('utf8')
	} catch {}
	return text
}

function retrieveKey() {
	let key = localStorage.getItem('emailnamegen-key')
	if(key) {
		elKey.value = key
	}
}

function onUpdateKey() {
	localStorage.setItem('emailnamegen-key', elKey.value)
	onUpdateName()
}
elKey.onkeyup = elKey.onchange = onUpdateKey


function onUpdateOutput() {
	elName.value = calcName(elKey.value, elOut.value)
}
elOut.onchange = elOut.onkeyup = onUpdateOutput

function onUpdateName() {
	elOut.value = calcOutput(elKey.value, elName.value)
}
elName.onchange = elName.onkeyup = onUpdateName

document.getElementById('btnClearName').onclick = function clearName() {
	elName.value = ''
}

document.getElementById('btnCopyToClipboard').onclick = function copyOutputToClipboard() {
	navigator.clipboard.writeText(elOut.value)
}

retrieveKey()
	</script>
</body>
</html>